<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Passport Auto-Scanner</title>
    <script src="js/mrz-worker.bundle-min-wrapped.js"></script>
    <script src="js/demo.bundle-min.js"></script>
    <style>
        body { padding: 20px; font-family: sans-serif; background: #f0f0f0; text-align: center; }
        #status { background: #333; color: #0f0; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        #result-box { background: white; padding: 20px; border-radius: 10px; text-align: left; display: none; margin-top: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        input#photo { display: none; }
    </style>
</head>
<body>
    <div id="status">READY: Waiting for Python Upload...</div>
    <input type="file" id="photo" name="photo"/>
    
    <div id="result-box">
        <h3 style="margin:0 0 10px 0;">Passport Data Detected:</h3>
        <pre id="json-output"></pre>
    </div>

    <div id="detected" style="display:none;"></div>
    <div id="parsed" style="display:none;"></div>

    <script>
        let lastSize = 0;
        let finalData = null;

        // Watch for file changes
        setInterval(async () => {
            try {
                const res = await fetch(`passport_scan.jpg?t=${Date.now()}`);
                const blob = await res.blob();
                if (blob.size !== lastSize) {
                    lastSize = blob.size;
                    const file = new File([blob], "scan.jpg", { type: "image/jpeg" });
                    const dt = new DataTransfer();
                    dt.items.add(file);
                    document.getElementById('photo').files = dt.files;
                    document.getElementById('photo').dispatchEvent(new Event('change', { bubbles: true }));
                }
            } catch (e) {}
        }, 3000);

        // Continuous Broadcast to Extension
        setInterval(() => {
            if (finalData) {
                window.postMessage({ type: "MRZ_DATA_EXT", payload: finalData }, "*");
            }
        }, 2000);

        const originalLog = console.log;
        console.log = function(msg) {
            originalLog.apply(console, arguments);
            if (msg && (msg.formatted || msg.lastName)) {
                const d = msg.formatted || msg;
                finalData = {
                    firstName: d.firstName || "N/A",
                    lastName: d.lastName || "N/A",
                    fullName: `${d.firstName || ''} ${d.lastName || ''}`.trim(),
                    dateOfBirth: formatMyDate(d.birthDate || d.dob),
                    passportNumber: d.documentNumber || "N/A",
                    expiryDate: formatMyDate(d.expirationDate || d.expiry)
                };
                document.getElementById('result-box').style.display = "block";
                document.getElementById('json-output').innerText = JSON.stringify(finalData, null, 4);
                document.getElementById('status').innerText = "âœ… DATA CAPTURED - Sending to Extension...";
            }
        };

        function formatMyDate(s) {
            if (!s || s.length < 6) return s;
            return `${s.substring(4,6)}/${s.substring(2,4)}/${s.substring(0,2)}`;
        }
    </script>
</body>
</html>
