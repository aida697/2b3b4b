<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Automated Scanner</title>
    <script src="js/mrz-worker.bundle-min-wrapped.js"></script>
    <script src="js/demo.bundle-min.js"></script>
    <style>
        body { background: #1a1a1a; color: white; font-family: sans-serif; text-align: center; }
        #status { padding: 20px; font-weight: bold; color: #0f0; }
        #result-box { background: white; color: black; margin: 20px; padding: 20px; border-radius: 10px; text-align: left; display: none; }
        input#photo { display: none; }
    </style>
</head>
<body>
    <div id="status">SYSTEM READY: Waiting for Python image...</div>
    <input type="file" id="photo" name="photo"/>
    <div id="result-box"></div>
    <div id="detected" style="display:none;"></div>
    <div id="parsed" style="display:none;"></div>

    <script>
        let lastSize = 0;
        const photoInput = document.getElementById('photo');

        // 1. Check for Python Upload every 3 seconds
        setInterval(async () => {
            try {
                const imgUrl = `passport_scan.jpg?t=${new Date().getTime()}`;
                const res = await fetch(imgUrl);
                const blob = await res.blob();
                
                if (blob.size !== lastSize) {
                    lastSize = blob.size;
                    document.getElementById('status').innerText = "NEW SCAN DETECTED...";
                    
                    const file = new File([blob], "scan.jpg", { type: "image/jpeg" });
                    const dt = new DataTransfer();
                    dt.items.add(file);
                    photoInput.files = dt.files;
                    photoInput.dispatchEvent(new Event('change', { bubbles: true }));
                }
            } catch (e) {}
        }, 3000);

        // 2. Intercept and reformat the output to YOUR format
        const originalLog = console.log;
        console.log = function(msg) {
            originalLog.apply(console, arguments);
            if (msg && (msg.formatted || msg.raw)) {
                const data = msg.formatted || {};
                
                // Map the data to the EXACT JSON you requested
                const myFormat = {
                    firstName: data.firstName || "N/A",
                    lastName: data.lastName || "N/A",
                    fullName: `${data.firstName || ''} ${data.lastName || ''}`.trim(),
                    dateOfBirth: formatMyDate(data.dob),
                    passportNumber: data.documentNumber || "N/A",
                    nationality: data.nationality || "N/A",
                    sex: data.sex || "N/A",
                    expiryDate: formatMyDate(data.expiry),
                    country: data.issuer || "N/A"
                };

                displayAndSend(myFormat);
            }
        };

        function formatMyDate(str) {
            if (!str || str.length !== 6) return str;
            return `${str.substring(4,6)}/${str.substring(2,4)}/${str.substring(0,2)}`;
        }

        function displayAndSend(data) {
            const box = document.getElementById('result-box');
            box.style.display = "block";
            box.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            window.postMessage({ type: "MRZ_DATA_EXT", payload: data }, "*");
            document.getElementById('status').innerText = "âœ… DATA CAPTURED";
        }
    </script>
</body>
</html>
