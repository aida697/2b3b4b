<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Passport Auto-Scanner</title>
    <script src="js/mrz-worker.bundle-min-wrapped.js"></script>
    <script src="js/demo.bundle-min.js"></script>
    <style>
        body { background: #121212; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; text-align: center; padding: 20px; }
        #status-bar { background: #333; padding: 15px; border-radius: 8px; border-left: 5px solid #00ff00; margin-bottom: 20px; font-family: monospace; }
        #result-box { background: white; color: #222; margin: 0 auto; padding: 20px; border-radius: 12px; text-align: left; max-width: 600px; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        pre { background: #f4f4f4; padding: 10px; border-radius: 5px; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word; }
        input#photo { display: none; }
    </style>
</head>
<body>
    <div id="status-bar">SYSTEM ONLINE: Waiting for image from Python...</div>
    <input type="file" id="photo" name="photo" accept="image/jpeg"/>
    
    <div id="result-box">
        <h2 style="margin-top:0; color:#007bff;">Passport Data Captured</h2>
        <div id="json-output"></div>
    </div>

    <div id="detected" style="display:none;"></div>
    <div id="parsed" style="display:none;"></div>

    <script>
        let lastImageSize = 0;
        const photoInput = document.getElementById('photo');
        const status = document.getElementById('status-bar');

        setInterval(async () => {
            try {
                const imgUrl = `passport_scan.jpg?t=${new Date().getTime()}`;
                const res = await fetch(imgUrl);
                if (!res.ok) return;
                
                const blob = await res.blob();
                if (blob.size !== lastImageSize && blob.size > 0) {
                    lastImageSize = blob.size;
                    status.innerText = "NEW IMAGE DETECTED! Processing MRZ...";
                    
                    const file = new File([blob], "scan.jpg", { type: "image/jpeg" });
                    const dt = new DataTransfer();
                    dt.items.add(file);
                    photoInput.files = dt.files;
                    
                    setTimeout(() => {
                        photoInput.dispatchEvent(new Event('change', { bubbles: true }));
                    }, 500);
                }
            } catch (e) { console.log("Waiting for file..."); }
        }, 3000);

        const originalLog = console.log;
        console.log = function(msg) {
            originalLog.apply(console, arguments);
            
            if (msg && typeof msg === 'object') {
                // Mapping specifically for your library output
                const d = msg.formatted || (msg.fields ? msg.fields : msg);
                
                // Only trigger if we have a lastName (meaning scan succeeded)
                if (d.lastName) {
                    const finalJSON = {
                        "firstName": d.firstName || "N/A",
                        "lastName": d.lastName || "N/A",
                        "fullName": `${d.firstName || ''} ${d.lastName || ''}`.trim(),
                        "dateOfBirth": formatDate(d.birthDate || d.dob),
                        "passportNumber": d.documentNumber || "N/A",
                        "nationality": d.nationality || "N/A",
                        "sex": d.sex || "N/A",
                        "expiryDate": formatDate(d.expirationDate || d.expiry),
                        "country": d.issuingState || d.issuer || "N/A"
                    };
                    renderResult(finalJSON);
                }
            }
        };

        function formatDate(s) {
            if (!s || s.length < 6) return s;
            return `${s.substring(4,6)}/${s.substring(2,4)}/${s.substring(0,2)}`;
        }

        function renderResult(data) {
            document.getElementById('result-box').style.display = "block";
            document.getElementById('json-output').innerHTML = `<pre>${JSON.stringify(data, null, 4)}</pre>`;
            status.innerText = "âœ… SCAN SUCCESSFUL";
            status.style.borderLeftColor = "#00ff00";
            
            window.postMessage({ type: "MRZ_DATA_EXT", payload: data }, "*");
        }
    </script>
</body>
</html>
