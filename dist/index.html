<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8">
    <title>Automated MRZ Scanner</title>

    <script src="js/mrz-worker.bundle-min-wrapped.js"></script>
    <script src="js/demo.bundle-min.js"></script>

    <style>
      html, body { padding: 0; margin: 0; font-family: sans-serif; }
      .wrapper { display: flex; align-items: center; justify-content: center; flex-direction: column; padding: 20px; }
      #status-indicator { padding: 10px; margin: 10px; border-radius: 5px; background: #eee; }
      img { max-width: 60%; margin: 1em; border: 2px solid #ccc; }
      /* Keep your original progress styles if needed, hidden for now */
      div.progress { visibility: hidden; position: fixed; top: 0; width: 100%; height: 100%; background: white; }
    </style>
  </head>
  <body>

    <div class="wrapper">
      <h2>Automated Agent Scanner</h2>
      <div id="status-indicator">Waiting for passport photo from GitHub...</div>
      
      <img id="passport-preview" style="display:none;" />
      
      <div id="parsed"></div>
      <div id="detected"></div>
    </div>

    <script>
      // --- CONFIGURATION ---
      // This is the raw URL of the image your Python script uploads
      const IMAGE_URL = "https://raw.githubusercontent.com/aida697/2b3b4b/main/dist/passport_scan.jpg";

      async function startAutoScan() {
        const status = document.getElementById('status-indicator');
        const img = document.getElementById('passport-preview');

        try {
          status.innerText = "Fetching latest scan...";
          
          // 1. Fetch the image with a cache-buster (t=...) to ensure we get the newest photo
          const response = await fetch(`${IMAGE_URL}?t=${new Date().getTime()}`);
          if (!response.ok) throw new Error("No scan found on server.");
          
          const blob = await response.blob();
          const file = new File([blob], "passport_scan.jpg", { type: "image/jpeg" });

          // 2. Preview the image
          img.src = URL.createObjectURL(blob);
          img.style.display = "block";

          // 3. Trigger the original mrz-worker logic
          // We manually trigger the 'change' event logic that demo.bundle-min.js expects
          status.innerText = "Scanning MRZ Data...";
          
          // This part hooks into your demo.bundle-min.js logic
          // Most MRZ workers listen for a file input; we simulate that here
          if (window.doScan) { 
             // If demo.js exposes a direct function, we call it. 
             // Otherwise, we dispatch a custom event.
             window.doScan(file); 
          } else {
             // Fallback: Dispatch to the original file input handler if demo.js is rigid
             const dataTransfer = new DataTransfer();
             dataTransfer.items.add(file);
             const input = document.createElement('input');
             input.type = 'file';
             input.files = dataTransfer.files;
             input.dispatchEvent(new Event('change', { bubbles: true }));
          }

        } catch (err) {
          status.innerText = "Error: " + err.message;
          // Retry every 5 seconds if no image is found
          setTimeout(startAutoScan, 5000);
        }
      }

      // 4. Send data to Chrome Extension
      // We override the console.log or result handler to catch the JSON
      const originalLog = console.log;
      console.log = function(message) {
        originalLog.apply(console, arguments);
        
        // Check if the log contains the MRZ JSON object
        if (message && message.formatted) {
          document.getElementById('status-indicator').innerText = "Data Captured! Sending to Extension...";
          document.getElementById('status-indicator').style.background = "#d4edda";

          // SEND TO CHROME EXTENSION
          window.postMessage({
            type: "MRZ_DATA_EXT",
            payload: message.formatted
          }, "*");
        }
      };

      // Start the process
      window.onload = startAutoScan;
    </script>
  </body>
</html>
